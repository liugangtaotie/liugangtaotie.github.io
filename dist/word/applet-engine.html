<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第十章、小程序引擎原理及实现 | 大前端技术交流文档</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="大前端技术交流文档">
    
    <link rel="preload" href="/assets/css/0.styles.1d48eac9.css" as="style"><link rel="preload" href="/assets/js/app.1209b5ce.js" as="script"><link rel="preload" href="/assets/js/4.de537007.js" as="script"><link rel="preload" href="/assets/js/1.f2ff10e3.js" as="script"><link rel="preload" href="/assets/js/5.157bb445.js" as="script"><link rel="prefetch" href="/assets/js/10.6081436e.js"><link rel="prefetch" href="/assets/js/11.d773a070.js"><link rel="prefetch" href="/assets/js/12.0b500a33.js"><link rel="prefetch" href="/assets/js/13.73f481d0.js"><link rel="prefetch" href="/assets/js/14.bab09012.js"><link rel="prefetch" href="/assets/js/15.8d1c1400.js"><link rel="prefetch" href="/assets/js/16.f5a11792.js"><link rel="prefetch" href="/assets/js/17.50b16102.js"><link rel="prefetch" href="/assets/js/18.42729e94.js"><link rel="prefetch" href="/assets/js/19.ab66d78b.js"><link rel="prefetch" href="/assets/js/20.c8e99e53.js"><link rel="prefetch" href="/assets/js/21.6abe2606.js"><link rel="prefetch" href="/assets/js/22.d662a6b7.js"><link rel="prefetch" href="/assets/js/23.0b75c54b.js"><link rel="prefetch" href="/assets/js/24.b091d7d3.js"><link rel="prefetch" href="/assets/js/25.8ef6d76e.js"><link rel="prefetch" href="/assets/js/26.4bf8b9ed.js"><link rel="prefetch" href="/assets/js/27.88984930.js"><link rel="prefetch" href="/assets/js/28.0ff9642c.js"><link rel="prefetch" href="/assets/js/29.1e044577.js"><link rel="prefetch" href="/assets/js/3.6148232d.js"><link rel="prefetch" href="/assets/js/30.3dfd05ec.js"><link rel="prefetch" href="/assets/js/31.0346911c.js"><link rel="prefetch" href="/assets/js/32.64065ea8.js"><link rel="prefetch" href="/assets/js/33.a5339ea5.js"><link rel="prefetch" href="/assets/js/34.40a6dd03.js"><link rel="prefetch" href="/assets/js/35.66f4cd75.js"><link rel="prefetch" href="/assets/js/36.417fe643.js"><link rel="prefetch" href="/assets/js/37.ea43d481.js"><link rel="prefetch" href="/assets/js/38.42551438.js"><link rel="prefetch" href="/assets/js/39.d1504611.js"><link rel="prefetch" href="/assets/js/40.c5969b98.js"><link rel="prefetch" href="/assets/js/41.2fdd2486.js"><link rel="prefetch" href="/assets/js/42.ff9a85d8.js"><link rel="prefetch" href="/assets/js/43.1d1834a0.js"><link rel="prefetch" href="/assets/js/44.a10f37da.js"><link rel="prefetch" href="/assets/js/45.65fb8fa4.js"><link rel="prefetch" href="/assets/js/46.e59819cd.js"><link rel="prefetch" href="/assets/js/47.454685dd.js"><link rel="prefetch" href="/assets/js/48.6f195d2d.js"><link rel="prefetch" href="/assets/js/49.5a83d381.js"><link rel="prefetch" href="/assets/js/50.a6a5d7e0.js"><link rel="prefetch" href="/assets/js/51.17652247.js"><link rel="prefetch" href="/assets/js/52.106da2d2.js"><link rel="prefetch" href="/assets/js/53.01735601.js"><link rel="prefetch" href="/assets/js/54.771be319.js"><link rel="prefetch" href="/assets/js/55.eda87db7.js"><link rel="prefetch" href="/assets/js/56.d5b10fc7.js"><link rel="prefetch" href="/assets/js/57.f6bc4899.js"><link rel="prefetch" href="/assets/js/58.a2fd2751.js"><link rel="prefetch" href="/assets/js/59.67cb09e1.js"><link rel="prefetch" href="/assets/js/6.c8b06e7c.js"><link rel="prefetch" href="/assets/js/60.37d60db8.js"><link rel="prefetch" href="/assets/js/61.26443320.js"><link rel="prefetch" href="/assets/js/62.d9eead19.js"><link rel="prefetch" href="/assets/js/63.5b123747.js"><link rel="prefetch" href="/assets/js/64.900aea21.js"><link rel="prefetch" href="/assets/js/65.43c4754f.js"><link rel="prefetch" href="/assets/js/66.0b1051c6.js"><link rel="prefetch" href="/assets/js/67.95c6261b.js"><link rel="prefetch" href="/assets/js/68.a509e22c.js"><link rel="prefetch" href="/assets/js/69.f834850c.js"><link rel="prefetch" href="/assets/js/7.c5ec4ce9.js"><link rel="prefetch" href="/assets/js/70.8579497f.js"><link rel="prefetch" href="/assets/js/71.5b1bfaed.js"><link rel="prefetch" href="/assets/js/72.03d2bd11.js"><link rel="prefetch" href="/assets/js/73.1ff8867b.js"><link rel="prefetch" href="/assets/js/74.6bf76e46.js"><link rel="prefetch" href="/assets/js/75.8fa435cf.js"><link rel="prefetch" href="/assets/js/76.bd035b49.js"><link rel="prefetch" href="/assets/js/8.93917932.js"><link rel="prefetch" href="/assets/js/9.9797576c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.1d48eac9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container" data-v-2a0acbb5><div data-v-2a0acbb5><div class="password-shadow password-wrapper-out" style="display:none;" data-v-6afaaa56 data-v-2a0acbb5 data-v-2a0acbb5><h3 class="title" data-v-6afaaa56>大前端技术交流文档</h3> <p class="description" data-v-6afaaa56>大前端技术交流文档</p> <label id="box" class="inputBox" data-v-6afaaa56><input type="password" value="" data-v-6afaaa56> <span data-v-6afaaa56>Konck! Knock!</span> <button data-v-6afaaa56>OK</button></label> <div class="footer" data-v-6afaaa56><span data-v-6afaaa56><i class="iconfont reco-theme" data-v-6afaaa56></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-6afaaa56>vuePress-theme-reco</a></span> <span data-v-6afaaa56><i class="iconfont reco-copyright" data-v-6afaaa56></i> <a data-v-6afaaa56><span data-v-6afaaa56>wuxiang</span>
          
        <span data-v-6afaaa56>2020 - </span>
        2023
      </a></span></div></div> <div class="hide" data-v-2a0acbb5><header class="navbar" data-v-2a0acbb5><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/frontender.png" alt="大前端技术交流文档" class="logo"> <span class="site-name">大前端技术交流文档</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-blog"></i>
      文章
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/word/vite-libs.html" class="nav-link"><i class="undefined"></i>
  日常
</a></li><li class="dropdown-item"><!----> <a href="/other/shields.html" class="nav-link"><i class="undefined"></i>
  其他
</a></li><li class="dropdown-item"><!----> <a href="/schedule/2022.html" class="nav-link"><i class="undefined"></i>
  计划
</a></li><li class="dropdown-item"><!----> <a href="/attention/one.html" class="nav-link"><i class="undefined"></i>
  关注
</a></li><li class="dropdown-item"><!----> <a href="/cultural/zhuangzi.html" class="nav-link"><i class="undefined"></i>
  文化
</a></li><li class="dropdown-item"><!----> <a href="/architecture/essence.html" class="nav-link"><i class="undefined"></i>
  架构
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-api"></i>
      文档
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/js-native.html" class="nav-link"><i class="undefined"></i>
  JS-Native
</a></li><li class="dropdown-item"><!----> <a href="/document/app-qr-code.html" class="nav-link"><i class="undefined"></i>
  app-qr-code
</a></li><li class="dropdown-item"><!----> <a href="/document/miniapp-qr-code.html" class="nav-link"><i class="undefined"></i>
  miniapp-qr-code
</a></li><li class="dropdown-item"><!----> <a href="/document/docking-document.html" class="nav-link"><i class="undefined"></i>
  docking-document
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      代码规范
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/codeDoc/git-doc.html" class="nav-link"><i class="undefined"></i>
  git-使用规范
</a></li><li class="dropdown-item"><!----> <a href="/codeDoc/ios-doc.html" class="nav-link"><i class="undefined"></i>
  iOS-代码规范
</a></li><li class="dropdown-item"><!----> <a href="/codeDoc/h5-doc.html" class="nav-link"><i class="undefined"></i>
  h5-代码规范
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-blog"></i>
      博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://liugangtaotie.github.io/d3-tree-example/#/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  d3
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://liugangtaotie.github.io/h5-document-vite-web/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  widget
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-github"></i>
      gitlab
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/liugangtaotie/h5-document.git" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  main
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-2a0acbb5></div> <aside class="sidebar" data-v-2a0acbb5><div class="personal-info-wrapper" data-v-3382c467 data-v-2a0acbb5><img src="/leaf.png" alt="author-avatar" class="personal-img" data-v-3382c467> <h3 class="name" data-v-3382c467>
    wuxiang
  </h3> <div class="num" data-v-3382c467><div data-v-3382c467><h3 data-v-3382c467>66</h3> <h6 data-v-3382c467>Articles</h6></div> <div data-v-3382c467><h3 data-v-3382c467>7</h3> <h6 data-v-3382c467>Tags</h6></div></div> <ul class="social-links" data-v-3382c467></ul> <hr data-v-3382c467></div> <nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-blog"></i>
      文章
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/word/vite-libs.html" class="nav-link"><i class="undefined"></i>
  日常
</a></li><li class="dropdown-item"><!----> <a href="/other/shields.html" class="nav-link"><i class="undefined"></i>
  其他
</a></li><li class="dropdown-item"><!----> <a href="/schedule/2022.html" class="nav-link"><i class="undefined"></i>
  计划
</a></li><li class="dropdown-item"><!----> <a href="/attention/one.html" class="nav-link"><i class="undefined"></i>
  关注
</a></li><li class="dropdown-item"><!----> <a href="/cultural/zhuangzi.html" class="nav-link"><i class="undefined"></i>
  文化
</a></li><li class="dropdown-item"><!----> <a href="/architecture/essence.html" class="nav-link"><i class="undefined"></i>
  架构
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-api"></i>
      文档
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/document/js-native.html" class="nav-link"><i class="undefined"></i>
  JS-Native
</a></li><li class="dropdown-item"><!----> <a href="/document/app-qr-code.html" class="nav-link"><i class="undefined"></i>
  app-qr-code
</a></li><li class="dropdown-item"><!----> <a href="/document/miniapp-qr-code.html" class="nav-link"><i class="undefined"></i>
  miniapp-qr-code
</a></li><li class="dropdown-item"><!----> <a href="/document/docking-document.html" class="nav-link"><i class="undefined"></i>
  docking-document
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      代码规范
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/codeDoc/git-doc.html" class="nav-link"><i class="undefined"></i>
  git-使用规范
</a></li><li class="dropdown-item"><!----> <a href="/codeDoc/ios-doc.html" class="nav-link"><i class="undefined"></i>
  iOS-代码规范
</a></li><li class="dropdown-item"><!----> <a href="/codeDoc/h5-doc.html" class="nav-link"><i class="undefined"></i>
  h5-代码规范
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  tag
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间轴
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-blog"></i>
      博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://liugangtaotie.github.io/d3-tree-example/#/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  d3
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://liugangtaotie.github.io/h5-document-vite-web/" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  widget
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-github"></i>
      gitlab
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/liugangtaotie/h5-document.git" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  main
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <ul class="sidebar-links"><li><a href="/word/vite-libs.html" class="sidebar-link">第三十三章、use-vite-for-javascript-libraries</a></li><li><a href="/word/data-visualization.html" class="sidebar-link">第三十二章、数据可视化</a></li><li><a href="/word/d3.html" class="sidebar-link">第三十一章、d3</a></li><li><a href="/word/v8.html" class="sidebar-link">第三十章、v8</a></li><li><a href="/word/handwriting-vite.html" class="sidebar-link">第二十九章、手写vite</a></li><li><a href="/word/vue-ssr.html" class="sidebar-link">第二十八章、vue-ssr</a></li><li><a href="/word/module-federation.html" class="sidebar-link">第二十七章、module-federation</a></li><li><a href="/word/web-component.html" class="sidebar-link">第二十六章、webComponent</a></li><li><a href="/word/micro-app.html" class="sidebar-link">第二十五章、micro-app</a></li><li><a href="/word/qiankun.html" class="sidebar-link">第二十四章、qiankun</a></li><li><a href="/word/ios-h5.html" class="sidebar-link">第二十三章、ios-h5</a></li><li><a href="/word/block-inline-element.html" class="sidebar-link">第二十二章、行内元素和块级元素</a></li><li><a href="/word/babel.html" class="sidebar-link">第二十一章、babel</a></li><li><a href="/word/auto-deploy.html" class="sidebar-link">第二十章、自动化部署</a></li><li><a href="/word/ceiling-scheme.html" class="sidebar-link">第十九章、基于vue的吸顶方案</a></li><li><a href="/word/css-var.html" class="sidebar-link">第十八章、vue3选择css变量</a></li><li><a href="/word/debounce.html" class="sidebar-link">第十七章、vue3防抖</a></li><li><a href="/word/multi-end-unified.html" class="sidebar-link">第十六章、多端统一</a></li><li><a href="/word/read-statistic.html" class="sidebar-link">第十五章、文档阅读量统计</a></li><li><a href="/word/d2.html" class="sidebar-link">第十四章、D2</a></li><li><a href="/word/static-online-img.html" class="sidebar-link">第十三章、添加站点图片</a></li><li><a href="/word/subpackage.html" class="sidebar-link">第十二章、uniapp优化策略</a></li><li><a href="/word/applet-principle.html" class="sidebar-link">第十一章、微信小程序技术原理分析</a></li><li><a href="/word/applet-engine.html" aria-current="page" class="active sidebar-link">第十章、小程序引擎原理及实现</a></li><li><a href="/word/applet.html" class="sidebar-link">第九章、小程序</a></li><li><a href="/word/xx-common-ui.html" class="sidebar-link">第八章、私有组件库</a></li><li><a href="/word/npm-private-library.html" class="sidebar-link">第七章、npm私有库搭建</a></li><li><a href="/word/design-patterns.html" class="sidebar-link">第六章、设计模式</a></li><li><a href="/word/js.html" class="sidebar-link">第五章、js</a></li><li><a href="/word/event-loop.html" class="sidebar-link">第四章、event-loop</a></li><li><a href="/word/vite.html" class="sidebar-link">第三章、vite</a></li><li><a href="/word/wxmp-next.html" class="sidebar-link">第二章、xx-next-code</a></li><li><a href="/word/wxmp.html" class="sidebar-link">第一章、common</a></li></ul> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-6afaaa56 data-v-2a0acbb5><h3 class="title" data-v-6afaaa56>第十章、小程序引擎原理及实现</h3> <!----> <label id="box" class="inputBox" data-v-6afaaa56><input type="password" value="" data-v-6afaaa56> <span data-v-6afaaa56>Konck! Knock!</span> <button data-v-6afaaa56>OK</button></label> <div class="footer" data-v-6afaaa56><span data-v-6afaaa56><i class="iconfont reco-theme" data-v-6afaaa56></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-6afaaa56>vuePress-theme-reco</a></span> <span data-v-6afaaa56><i class="iconfont reco-copyright" data-v-6afaaa56></i> <a data-v-6afaaa56><span data-v-6afaaa56>wuxiang</span>
          
        <span data-v-6afaaa56>2020 - </span>
        2023
      </a></span></div></div> <div data-v-2a0acbb5><div data-v-2a0acbb5><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">第十章、小程序引擎原理及实现</h1> <div data-v-4b52865a><i class="iconfont reco-account" data-v-4b52865a><span data-v-4b52865a>liugang</span></i> <i class="iconfont reco-date" data-v-4b52865a><span data-v-4b52865a>12/2/2020</span></i> <i class="iconfont reco-eye" data-v-4b52865a><span id="/word/applet-engine.html" data-flag-title="Your Article Title" class="leancloud-visitors" data-v-4b52865a><a class="leancloud-visitors-count" style="font-size:.9rem;font-weight:normal;color:#999;"></a></span></i> <i class="tags iconfont reco-tag" data-v-4b52865a><span class="tag-item" data-v-4b52865a>tag4</span></i></div></div> <div class="theme-reco-content content__default"><Boxx changeTime="5000"></Boxx> <h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <p>本文正式开篇讲实现原理之前，我想先简单说明一下小程序领域的现状，以及 EMP 框架研究方向的出发点和个人思考。目前基于统一的 DSL (Vue/React/自定义DSL) 转换到各家的小程序的框架一大堆，比如 mpvue、uni-app、Taro 等，这些框架解决的核心问题是实现一套开发代码编译到多端小程序。</p> <p>如果我们想从零开始做一个类似微信小程序的引擎，或者将微信小程序现有资源转换成 H5 容器、App 容器能够运行的资源，那么和一套 DSL 编译到各个平台的思路是恰好相反的。我们需要搞清楚小程序在小程序引擎是怎么跑起来的，各家小程序引擎实现机制不太一样，但是基本上都是参考微信小程序引擎做的实现，保留了小程序的双线程模型。各小程序平台的基础库是不一样的，微信小程序开发框架是 mina 框架，百度小程序小程序开发框架是 swan 框架，视图层都有一套自己实现的 mvvm 框架，逻辑层就相对比较一致，都是 JavaScript 引擎，无非是基于 V8 或 JavaScriptCore。</p> <p>目前小程序相关的框架可以分成以下大类：</p> <ul><li>统一的 DSL 编译到多平台小程序、H5、App，实现应用跨多端运行，典型的框架：<a href="https://github.com/Meituan-Dianping/mpvue" target="_blank" rel="noopener noreferrer">mpvue<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://github.com/dcloudio/uni-app" target="_blank" rel="noopener noreferrer">uni-app<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://github.com/max-team/Mars" target="_blank" rel="noopener noreferrer">Mars<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://github.com/NervJS/taro" target="_blank" rel="noopener noreferrer">Taro<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://rubylouvre.github.io/nanachi/index.html" target="_blank" rel="noopener noreferrer">Nanachi<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://github.com/didi/chameleon" target="_blank" rel="noopener noreferrer">Chameleon<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>；</li> <li>多平台小程序之间互相转换，实现小程序之间跨端运行，典型的框架：<a href="https://ant-move.github.io/website/" target="_blank" rel="noopener noreferrer">Antmove<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://smartprogram.baidu.com/docs/develop/tutorial/move" target="_blank" rel="noopener noreferrer">wx2swan<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://www.npmjs.com/package/@qihoo/wx2qh" target="_blank" rel="noopener noreferrer">@qihoo/wx2qh<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>；</li> <li>小程序编译到 Web、App 端运行，实现小程序资源的复用，典型的框架：<a href="https://github.com/chemzqm/wept" target="_blank" rel="noopener noreferrer">wept<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://github.com/wdfe/weweb" target="_blank" rel="noopener noreferrer">weweb<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://github.com/weidian-inc/hera" target="_blank" rel="noopener noreferrer">Hera<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>；</li> <li>类微信小程序的小程序引擎框架，典型的框架：<a href="https://github.com/swan-team/swan-js" target="_blank" rel="noopener noreferrer">swan-js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://github.com/weidian-inc/hera" target="_blank" rel="noopener noreferrer">Hera<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="http://openapplus.com/" target="_blank" rel="noopener noreferrer">OpenApp+<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://github.com/githubliruiyuan/HybridFlutter" target="_blank" rel="noopener noreferrer">HybridFlutter<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、<a href="https://github.com/zhaomenghuan/flutter-mini-program" target="_blank" rel="noopener noreferrer">flutter-mini-program<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</li></ul> <p><img src="/assets/img/transform-framework.9fae09fa.png" alt="Image text"></p> <p>小程序引擎可以参考的资料和内容比较少，目前可以借鉴的思路有两种：</p> <ul><li>参考微信小程序的实现，反编译微信开发者工具和基础库，基于 Hera 进行二次开发，将 Hera 中微信小程序开发框架 mina 框架(组件系统 <a href="https://www.npmjs.com/package/miniprogram-exparser" target="_blank" rel="noopener noreferrer">exparser<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>、vdom 等) 换成 Vue.js 框架等成熟的前端框架，引入组件系统开发类微信规范的小程序组件；</li> <li>参考百度小程序的实现，目前百度小程序前端核心框架 swan-js 开源，也可以考虑基于 swan 进行改造，比如有人将其中的 mvvm <a href="https://baidu.github.io/san" target="_blank" rel="noopener noreferrer">san<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 框架换成了 Vue 框架，<a href="https://github.com/handsomeliuyang/swanvue-core" target="_blank" rel="noopener noreferrer">swanvue-core<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，然后去实现宿主容器。</li></ul> <p>EMP 出发点来源于构建自定义小程序引擎时，尝试基于 Vue.js 框架作为视图层底层框架，然后组件标准和逻辑层模仿微信小程序，目前已经初步实现了简单的一个小程序容器。如果以 Vue 作为初始 DSL 直接开发小程序也不是不可以，但是小程序生态现有的资源无非直接复用，能不能将小程序转换成 Vue.js 框架能运行的代码呢，这就是 EMP 框架最初的起点，定位是一种小程序引擎的实现，保留小程序双线程模型，基于 Vue.js 框架实现视图层渲染容器，使用 JavaScript 引擎实现小程序逻辑层调用。</p> <h2 id="小程序-native-web"><a href="#小程序-native-web" class="header-anchor">#</a> 小程序 &amp; Native &amp; Web</h2> <p>从 PC 时代开始，Native 与 Web 就一直是相互竞争、相互融合的关系，我们先来简单看看它们之间的优势与劣势。</p> <table><thead><tr><th style="text-align:center;"></th> <th style="text-align:center;">Native</th> <th style="text-align:center;">Web</th></tr></thead> <tbody><tr><td style="text-align:center;">性能</td> <td style="text-align:center;">高</td> <td style="text-align:center;">低</td></tr> <tr><td style="text-align:center;">用户体验</td> <td style="text-align:center;">好</td> <td style="text-align:center;">白屏、交互反馈差</td></tr> <tr><td style="text-align:center;">功能</td> <td style="text-align:center;">可以充分利用平台自身的能力</td> <td style="text-align:center;">只有使用 W3C 的标准能力</td></tr> <tr><td style="text-align:center;">迭代</td> <td style="text-align:center;">周期长，需要发布</td> <td style="text-align:center;">周期短，随时发布</td></tr> <tr><td style="text-align:center;">维护成本</td> <td style="text-align:center;">高</td> <td style="text-align:center;">低</td></tr> <tr><td style="text-align:center;">跨平台</td> <td style="text-align:center;">差</td> <td style="text-align:center;">好</td></tr> <tr><td style="text-align:center;">线程</td> <td style="text-align:center;">多线程</td> <td style="text-align:center;">单线程</td></tr></tbody></table> <p>可以看出，Native 与 Web 之间各有优劣，在移动互联网发展的过程中，开发者们也一直在寻找融合双方优势的方案，经历了以下四个阶段的发展：</p> <ul><li>Hybrid 1.0：为 Web 页面提供 Naive API 的能力，也就是用 JS Bridge 去增强系统的 WebView 的功能。缺点是：体验差，如滚动、动画与交互等，稳定性差，如列表内存占用大等。</li> <li>Hybrid 2.0：将 Native 组件覆盖在 WebView 之上，例如微信的 cover-view，提供更多的扩展能力。缺点是：用户体验融合性不好，如层级、事件、布局等。</li> <li>Hybrid 3.0：前端 DSL 开发，Native 渲染，例如 React Native 与 Weex。缺点：对 W3C 标准能力支持有限，存在平台差异，三端并不完全统一。</li> <li>Hybrid 4.0：百花齐放的小程序、快应用、轻应用方案，这个容器也有两种：WebView 容器与类 ReatNative 容器。技术方案上并没有太多的花样，这种方案的兴起由微信带起，本质上还是源于各大公司对于流量入口和生态的竞争。</li></ul> <p>小程序的特点：</p> <ul><li>使用 WebView 开发，门槛低，可云端更新。</li> <li>通过提供基础能力、原生组件结合等方式，提升用户体验。</li> <li>通过平台发布、审核、下架、封禁等能力，具备对小程序的管控能力。</li> <li>双线程（逻辑层和渲染层分开），隔离 DOM、BOM 能力，提升体验的同时，可保证 WebView 安全性。</li></ul> <p>小程序性能优化：</p> <ul><li>安装包缓存</li> <li>分包加载</li> <li>独立渲染线程</li> <li>webview 预加载</li> <li>Native 组件</li></ul> <p>可以看出来小程序是介于 Nativa 与 Web 两者间的应用形态，下面我们会从 Native 与 Web 两个不同的角度的看一下小程序的设计原理。</p> <h2 id="重新认识浏览器内核"><a href="#重新认识浏览器内核" class="header-anchor">#</a> 重新认识浏览器内核</h2> <p>在研究小程序引擎运行原理之前，我们需要对浏览器内核有一些基本认识，这样我们可以更好的理解小程序的设计思路。</p> <h3 id="browser-engine"><a href="#browser-engine" class="header-anchor">#</a> Browser engine</h3> <p>浏览器内核，浏览器引擎(Browser engine)，也称排版引擎(layout engine)、页面渲染引擎(rendering engine)。浏览器内核无非需要以下几个主要部分，如 HTML/CSS 解析器，网络处理，JavaScript 引擎，2D/3D 图形引擎，多媒体支持等。</p> <table><thead><tr><th style="text-align:center;">内核</th> <th style="text-align:center;">浏览器</th> <th style="text-align:center;">发布年份</th> <th style="text-align:center;">发布厂商</th> <th style="text-align:center;">维护状态</th> <th style="text-align:center;">JavaScript 引擎</th></tr></thead> <tbody><tr><td style="text-align:center;">Trident</td> <td style="text-align:center;">IE4 - IE11、360 浏览器</td> <td style="text-align:center;">1997</td> <td style="text-align:center;">Microsoft</td> <td style="text-align:center;">停止</td> <td style="text-align:center;">JScript/Chakra</td></tr> <tr><td style="text-align:center;">Gecko</td> <td style="text-align:center;">Firefox</td> <td style="text-align:center;">2004</td> <td style="text-align:center;">Netscape</td> <td style="text-align:center;">维护</td> <td style="text-align:center;">SpiderMonkey</td></tr> <tr><td style="text-align:center;">WebKit</td> <td style="text-align:center;">Safari、Chromium、Chrome(-2013)、Android 浏览器、Chrome OS、Web OS 等</td> <td style="text-align:center;">2005</td> <td style="text-align:center;">Apple</td> <td style="text-align:center;">维护</td> <td style="text-align:center;">JavascriptCore</td></tr> <tr><td style="text-align:center;">Blink</td> <td style="text-align:center;">Chrome(2013-)、 Opera</td> <td style="text-align:center;">2013</td> <td style="text-align:center;">Google</td> <td style="text-align:center;">维护</td> <td style="text-align:center;">V8</td></tr> <tr><td style="text-align:center;">Edge</td> <td style="text-align:center;">Edge</td> <td style="text-align:center;">2015</td> <td style="text-align:center;">Microsoft</td> <td style="text-align:center;">停止</td> <td style="text-align:center;">Chakra</td></tr></tbody></table> <h3 id="javascript-engine"><a href="#javascript-engine" class="header-anchor">#</a> JavaScript Engine</h3> <p>目前在 Android／iOS 上运行 JavaScript，主要有两种方法：一种方法是利用系统的浏览器组件 WebView（Android）和 UIWebView／WKWebView（iOS）；另一种方法是编译和集成一个功能全面的 JavaScript 引擎。JavaScript 引擎是一个专门处理 JavaScript 脚本的虚拟机，一般会附带在网页浏览器之中。</p> <table><thead><tr><th style="text-align:center;">JavaScript Engine</th> <th style="text-align:center;">Android</th> <th style="text-align:center;">iOS</th> <th style="text-align:center;">维护厂商/个人</th></tr></thead> <tbody><tr><td style="text-align:center;">V8</td> <td style="text-align:center;">JIT</td> <td style="text-align:center;">JIT only for jailbroken devices</td> <td style="text-align:center;">Google</td></tr> <tr><td style="text-align:center;">JavaScriptCore</td> <td style="text-align:center;">Interpreter and JIT</td> <td style="text-align:center;">Interpreter only</td> <td style="text-align:center;">Apple</td></tr> <tr><td style="text-align:center;">SpiderMonkey</td> <td style="text-align:center;">Interpreter and JIT</td> <td style="text-align:center;">Interpreter only</td> <td style="text-align:center;">Mozilla</td></tr> <tr><td style="text-align:center;">Rhino</td> <td style="text-align:center;">Interpreter</td> <td style="text-align:center;">Unsupported</td> <td style="text-align:center;">Mozilla</td></tr> <tr><td style="text-align:center;">quickjs</td> <td style="text-align:center;">-</td> <td style="text-align:center;">-</td> <td style="text-align:center;">Fabrice Bellard</td></tr></tbody></table> <h3 id="how-webkit-works"><a href="#how-webkit-works" class="header-anchor">#</a> How WebKit works</h3> <p>WebKit 工作原理可以看 <a href="https://docs.google.com/presentation/d/1ZRIQbUKw9Tf077odCh66OrrwRIVNLvI_nhLm2Gi__F0/pub?slide=id.p" target="_blank" rel="noopener noreferrer">How WebKit works<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 详细介绍。</p> <p><img src="/assets/img/webkit-architecture.450dc2ed.png" alt="Image text"></p> <p>WebKit 就是一个页面渲染以及逻辑处理引擎，前端工程师把 HTML、JavaScript、CSS 这“三驾马车”作为输入，经过 WebKit 的处理，就输出成了我们能看到以及操作的 Web 页面。从上图我们可以看出来，WebKit 由图中框住的四个部分组成，而其中最主要的就是 WebCore（KDE 开发的排版引擎） 和 JSCore（或者是其它 JS 引擎）。除此之外，WebKit Embedding API 是负责浏览器 UI 与 WebKit 进行交互的部分，而 WebKit Ports 则是让 Webkit 更加方便的移植到各个操作系统、平台上，提供的一些调用 Native Library 的接口，比如在渲染层面，在 iOS 系统中，Safari 是交给 CoreGraphics 处理，而在 Android 系统中，Webkit 则是交给 Skia。</p> <p>排版引擎 WebCore 的工作流程:</p> <p><img src="/assets/img/webkit-render.9abf6c96.png" alt="Image text"></p> <p>JavaScript 引擎 JSCore 的工作流程:</p> <p><img src="/assets/img/webkit-jscore.ee051da3.png" alt="Image text"></p> <h3 id="how-blink-works"><a href="#how-blink-works" class="header-anchor">#</a> How Blink works</h3> <p>Blink 工作原理可以看 <a href="http://bit.ly/how-blink-works" target="_blank" rel="noopener noreferrer">How Blink works<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 详细介绍。</p> <p><img src="/assets/img/blink-architecture.43eaf556.png" alt="Image text"></p> <p>Blink 渲染原理: bit.ly/lifeofapixel</p> <p><img src="/assets/img/life-of-a-pixel.e3fad5aa.png" alt="Image text"></p> <h2 id="主流小程序引擎架构"><a href="#主流小程序引擎架构" class="header-anchor">#</a> 主流小程序引擎架构</h2> <p>目前主流的小程序平台架构差异不小，但是核心实现设计思路相同，我们可以从这些通用的设计中去思考背后的思想。</p> <h3 id="微信小程序架构"><a href="#微信小程序架构" class="header-anchor">#</a> 微信小程序架构</h3> <p>微信小程序技术原理可以看之前写的一篇文章<a href="/word/applet-principle.html">《微信小程序技术原理分析》</a>。</p> <p>微信小程序技术栈系统架构：</p> <p><img src="/assets/img/wx-mp-architecture.7e7b2004.png" alt="Image text"></p> <p>Flutter 渲染优化 - 整体系统架构：</p> <p><img src="/assets/img/wx-mp-flutter.d73b4d15.png" alt="Image text"></p> <h3 id="百度小程序架构"><a href="#百度小程序架构" class="header-anchor">#</a> 百度小程序架构</h3> <p><img src="/assets/img/swan-mp-architecture.b5232cf4.png" alt="Image text"></p> <h3 id="支付宝小程序架构"><a href="#支付宝小程序架构" class="header-anchor">#</a> 支付宝小程序架构</h3> <p><img src="/assets/img/ali-mp-architecture.629d781d.png" alt="Image text"></p> <h3 id="快应用架构"><a href="#快应用架构" class="header-anchor">#</a> 快应用架构</h3> <p><img src="/assets/img/quickapp-architecture.7f65a6db.png" alt="Image text"></p> <h2 id="emp-小程序引擎设计"><a href="#emp-小程序引擎设计" class="header-anchor">#</a> EMP 小程序引擎设计</h2> <h3 id="整体架构"><a href="#整体架构" class="header-anchor">#</a> 整体架构</h3> <p>JS 层 Framework 架构：</p> <p><img src="/assets/img/emp-js.01611c1c.png" alt="Image text"></p> <p>Native 层 Android 平台小程序容器架构：</p> <p><img src="/assets/img/emp-sdk-architecture.1db4685e.png" alt="Image text"></p> <p>Emp Android SDK 被设计为运行在独立的进程中，独享进程内存，提供了可供小程序运行的丰富的 API 和组件，同时也提供了扩展 API 的能力。SDK 的核心功能主要有两部分: <code>逻辑流程控制</code> 和 <code>API实现</code>。</p> <ul><li>逻辑流程控制：SDK Native 层 [<code>EmpActivity</code>] 作为逻辑流程控制中心，建立了页面视图层 [<code>Page</code>] 与应用逻辑层 [<code>AppService</code>] 之间的联系，处理两层之间的事件传递及数据流转，同时也处理 API 的调用并返回结果。</li> <li>API 实现：SDK 本身提供了丰富的 API 实现，同时也提供了扩展 API 的接口，方便被接入的 App 实现自定义的 API 功能。由于 SDK 运行于独立进程，因此通过进程通信的方式调用宿主提供的扩展 API。</li></ul> <h3 id="包结构"><a href="#包结构" class="header-anchor">#</a> 包结构</h3> <p>小程序开发工程以微信小程序工程作为输入，经过编译器编译后生成如下结构的包。其中 framework 包独立于小程序包，通常内置于小程序引擎内。</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>├── framework            # 框架内置包
|   ├── service.js       # 框架 AppService 层
|   ├── view.js          # 框架 PageView 层
|   └── framework.css    # 框架通用样式
├── pages                # 视图层入口
|   ├── index/index.html
|   ├── ...
├── assets               # 静态资源
├── scripts
|   ├── app-config.js    # 全局配置
|   └── app-service.js   # 应用逻辑层
└── service.html         # 逻辑层入口
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><h3 id="启动流程"><a href="#启动流程" class="header-anchor">#</a> 启动流程</h3> <p>小程序引擎 Android 平台小程序启动流程图：</p> <p><img src="/assets/img/launch-process.2406ed4d.png" alt="Image text"></p> <h3 id="编译器"><a href="#编译器" class="header-anchor">#</a> 编译器</h3> <p>大多数编译器流程可以分为三个阶段：</p> <ul><li>解析(parse)：将代码字符串解析成抽象语法树；</li> <li>转换(transform)：对抽象语法树进行转换操作；</li> <li>生成(generate): 根据变换后的抽象语法树再生成代码字符串。</li></ul> <p><img src="/assets/img/miniprogram-translater.cd4de67f.png" alt="Image text"></p> <p>根据 HTML、JS、CSS 不同的语法规则，采用不同的中间编译工具，Unified、Babel、PostCSS 都支持插件系统。中间转换插件主要解决语法转换，wxml2vue 核心逻辑主要是提供了将小程序文件编译成能够用于 Vue 框架运行的代码。</p> <h4 id="属性转换"><a href="#属性转换" class="header-anchor">#</a> 属性转换</h4> <p>将微信小程序标签上的属性绑定语法变为 Vue 绑定语法，如：</p> <table><thead><tr><th style="text-align:center;">微信小程序</th> <th style="text-align:center;">Vue</th></tr></thead> <tbody><tr><td style="text-align:center;">id=&quot;item&quot;</td> <td style="text-align:center;">id=&quot;item&quot;</td></tr> <tr><td style="text-align:center;">id=&quot;&quot;</td> <td style="text-align:center;">:id=&quot;item&quot;</td></tr></tbody></table> <p><strong>Class 转换</strong></p> <p>WXML 源代码:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>view</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>static-class {{ dynamicClassFlag ? 'dynamic-class': ''}}<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Class<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>view</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>AST 转换代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 判断是否{{}}数据绑定
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">hasDataBindBrackets</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">{{(.+?)}}</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 获取{{}}数据绑定模板表达式
 * @param {*} value
 */</span>
<span class="token keyword">const</span> <span class="token function-variable function">removeDataBindBrackets</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> match <span class="token operator">=</span> <span class="token operator">!</span><span class="token function">isEmptyString</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">{{(.+?)}}</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>match <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">?</span> value <span class="token operator">:</span> match<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">transformClassAtrr</span><span class="token punctuation">(</span><span class="token parameter">node</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> attribs <span class="token punctuation">}</span> <span class="token operator">=</span> node<span class="token punctuation">;</span>
  <span class="token keyword">const</span> value <span class="token operator">=</span> attribs<span class="token punctuation">[</span>attr<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasDataBindBrackets</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    attribs<span class="token punctuation">[</span><span class="token string">'class'</span><span class="token punctuation">]</span> <span class="token operator">=</span> value<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">{{.+?}}</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">' '</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    attribs<span class="token punctuation">[</span><span class="token string">'v-bind:class'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">removeDataBindBrackets</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> attribs<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>经过 AST 转换后生成代码为：</p> <div class="language-text line-numbers-mode"><pre class="language-text"><code>&amp;lt;ui-view class=&quot;static-class&quot; v-bind:class=&quot;dynamicClassFlag ? 'dynamic-class': ''&quot;&gt;Class&amp;lt;/ui-view&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="指令转换"><a href="#指令转换" class="header-anchor">#</a> 指令转换</h4> <p>将微信小程序的指令转换为 Vue 指令：</p> <table><thead><tr><th style="text-align:center;">微信小程序</th> <th style="text-align:center;">Vue</th></tr></thead> <tbody><tr><td style="text-align:center;">wx:for=&quot;&quot; wx:for-item=&quot;xxx&quot;wx:for-index=&quot;yyy&quot;</td> <td style="text-align:center;">v-for=&quot;(xxx, yyy) in array&quot;</td></tr> <tr><td style="text-align:center;">wx:if</td> <td style="text-align:center;">v-if</td></tr> <tr><td style="text-align:center;">wx:elif</td> <td style="text-align:center;">v-else-if</td></tr> <tr><td style="text-align:center;">wx:else</td> <td style="text-align:center;">v-else</td></tr></tbody></table> <h4 id="组件转换"><a href="#组件转换" class="header-anchor">#</a> 组件转换</h4> <p>将微信小程序组件转换为 Vue 组件。</p> <h4 id="事件转换"><a href="#事件转换" class="header-anchor">#</a> 事件转换</h4> <p>引入手势库<a href="http://hammerjs.github.io/" target="_blank" rel="noopener noreferrer">hammerjs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，默认支持 Tap、Press、Swipe、Pan、Pinch、Rotate 等基本手势。</p> <p>WXML 源代码:</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>primary<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tap<span class="token punctuation">&quot;</span></span> <span class="token attr-name">bindtap</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>showToast<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>tap<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>primary<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>longpress<span class="token punctuation">&quot;</span></span> <span class="token attr-name">bindlongpress</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>showToast<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>longpress<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>AST 转换代码：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">transformOnDirective</span><span class="token punctuation">(</span><span class="token parameter">attr<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> eventType <span class="token operator">=</span> attr<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> eventName <span class="token operator">=</span> value<span class="token punctuation">;</span>
  <span class="token keyword">let</span> newAttr <span class="token operator">=</span> attr<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>eventType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'touchstart'</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token string">'touchmove'</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token string">'touchcancel'</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token string">'touchend'</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token string">'transitionend'</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token string">'animationstart'</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token string">'animationiteration'</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token string">'animationend'</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token string">'touchforcechange'</span><span class="token operator">:</span>
      newAttr <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">v-on:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>eventType<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'tap'</span><span class="token operator">:</span>
      newAttr <span class="token operator">=</span> <span class="token string">'v-on:tap.native'</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'longtap'</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token string">'longpress'</span><span class="token operator">:</span>
      newAttr <span class="token operator">=</span> <span class="token string">'v-on:press.native'</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      console<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'不支持的事件: '</span><span class="token punctuation">,</span> eventType<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">attr</span><span class="token operator">:</span> newAttr<span class="token punctuation">,</span>
    <span class="token literal-property property">value</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">__eventHandleProxy__('</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>eventName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">', $event)</span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>经过 AST 转换后生成代码为：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ui-button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>primary<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>tap<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">v-on:</span>tap.native</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>__eventHandleProxy__('showToast', $event)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>tap<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ui-button</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>ui-button</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>primary<span class="token punctuation">&quot;</span></span> <span class="token attr-name">data-type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>longpress<span class="token punctuation">&quot;</span></span> <span class="token attr-name"><span class="token namespace">v-on:</span>press.native</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>__eventHandleProxy__('showToast', $event)<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>longpress<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>ui-button</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>小程序框架试视图层：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">data</span><span class="token operator">:</span> options<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
  <span class="token literal-property property">render</span><span class="token operator">:</span> options<span class="token punctuation">.</span>render<span class="token punctuation">,</span>
  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">__eventHandleProxy__</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">eventName</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">event</span><span class="token operator">:</span> Event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 转发 Page 事件到 AppService</span>
      global<span class="token punctuation">.</span>emp<span class="token punctuation">.</span><span class="token function">publishPageEvent</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> eventTransform<span class="token punctuation">.</span><span class="token function">intercept</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="通信机制"><a href="#通信机制" class="header-anchor">#</a> 通信机制</h3> <h4 id="javascript-层设计"><a href="#javascript-层设计" class="header-anchor">#</a> JavaScript 层设计</h4> <p>JSBridge 中有 invoke、invokeCallbackHandler、on、publish、subscribe、subscribeHandler 五个方法，下面会逐个介绍其作用与实现。</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">class</span> <span class="token class-name">JSBridge</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> callbackIndex<span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> eventPrefix<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">=</span> <span class="token string">'custom_event_'</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> callbacks<span class="token operator">:</span> Map<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token punctuation">,</span> <span class="token builtin">Function</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> defaultEventHandlers<span class="token operator">:</span> Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">Function</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">private</span> handlers<span class="token operator">:</span> Map<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">Function</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">/**
   * 逻辑层 JS 层异步调用 Native 层
   * @param {*} event
   * @param {*} params
   * @param {*} callback
   */</span>
  <span class="token function">invoke</span><span class="token punctuation">(</span>eventName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> params<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> callback<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> paramsString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> callbackId <span class="token operator">=</span> <span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>callbackIndex<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>callbackId<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>os<span class="token punctuation">.</span>isAndroid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> JSCoreHandleResult <span class="token operator">=</span> global<span class="token punctuation">.</span>EmpJSCore<span class="token punctuation">.</span><span class="token function">invokeHandler</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> paramsString<span class="token punctuation">,</span> callbackId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">let</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>callbackId<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">Function</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token operator">!</span><span class="token function">isUndefined</span><span class="token punctuation">(</span>JSCoreHandleResult<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">isFunction</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> JSCoreHandleResult <span class="token operator">!==</span> <span class="token string">''</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          JSCoreHandleResult <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>JSCoreHandleResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          JSCoreHandleResult <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">callback</span><span class="token punctuation">(</span>JSCoreHandleResult<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>callbackId<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>os<span class="token punctuation">.</span>isIOS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      global<span class="token punctuation">.</span>webkit<span class="token punctuation">.</span>messageHandlers<span class="token punctuation">.</span>invokeHandler<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token constant">C</span><span class="token operator">:</span> eventName<span class="token punctuation">,</span>
        paramsString<span class="token punctuation">,</span>
        callbackId
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

   <span class="token comment">/**
   * Native 层将 invoke 回调结果传递给 JS 层
   * @param {*} callbackId
   * @param {*} params
   */</span>
  <span class="token function">invokeCallbackHandler</span><span class="token punctuation">(</span>callbackId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> params<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> callback <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>callbackId<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">Function</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">callback</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>callbacks<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>callbackId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 监听默认事件
   * @param {*} eventName
   * @param {*} handler
   */</span>
  <span class="token function">on</span><span class="token punctuation">(</span>eventName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>defaultEventHandlers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 发布消息，由 Service 层或 View 层的 JSBridge 调用
   * @param {*} eventName
   * @param {*} params
   * @param {*} webviewIds
   */</span>
  <span class="token function">publish</span><span class="token punctuation">(</span>eventName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> params<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> webviewIds<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> event <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>eventPrefix <span class="token operator">+</span> eventName<span class="token punctuation">;</span>
    <span class="token keyword">const</span> paramsString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
    webviewIds <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>webviewIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>os<span class="token punctuation">.</span>isAndroid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      global<span class="token punctuation">.</span>EmpJSCore<span class="token punctuation">.</span><span class="token function">publishHandler</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> paramsString<span class="token punctuation">,</span> webviewIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>os<span class="token punctuation">.</span>isIOS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      global<span class="token punctuation">.</span>webkit<span class="token punctuation">.</span>messageHandlers<span class="token punctuation">.</span>publishHandler<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        event<span class="token punctuation">,</span>
        paramsString<span class="token punctuation">,</span>
        webviewIds
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 订阅消息
   * @param {*} eventName
   * @param {*} handler
   */</span>
  <span class="token function">subscribe</span><span class="token punctuation">(</span>eventName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> handler<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>handlers<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventPrefix <span class="token operator">+</span> eventName<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/**
   * 消息订阅处理器
   * @param {*} eventName
   * @param {*} data
   * @param {*} webviewId
   * @param {*} reportParams
   */</span>
  <span class="token function">subscribeHandler</span><span class="token punctuation">(</span>eventName<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> data<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> webviewId<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> handler <span class="token operator">=</span> <span class="token punctuation">(</span>eventName<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>eventPrefix<span class="token punctuation">)</span>
      <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handlers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventName<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>defaultEventHandlers<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>eventName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">Function</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">handler</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> webviewId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
global<span class="token punctuation">.</span>EmpJSBridge <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSBridge</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br></div></div><p>JS 层主动调用 Native 层：JS 层逻辑层使用 EmpJSBridge.invoke 异步调用 Native 层，Native 层将 invoke 方法的回调结果通过 Native 层调用 JS 层的 JSBridge.invokeCallbackHandler 方法回调给 JS 层。</p> <p><img src="data:image/png;base64,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yy+XZcuWZSdyww03yMiRI/M1l7feekvat2+vtAf6BO267777lKn9+eefUqJEidSAyWP2gAED5J9//lF6mTiefPJJufrqq+XXX3/N8fM2bdrIUUcdJaNGjSr0tbFApKFPPfWUwuLrr7+WOnXqpLR2SqbUpEkTlVji+M9//qMMJJ0jMqXMzEypVauWlC5dWoHcq1cvwe/Gjx8vw4YNU3//+eefpV69evLdd99JpUqV5LfffpM777xTpk+fLn/88YeUKlUqR2hbt26Vb775Rk455RSjppTfdQqDFU2pMOiZ+ezemBLvJf1axOle2rRpkxJxmBKMBdr0wQcfyPnnny+9e/eWwYMHJ01s6dKl0rJlS2UM9957r8DcoGPpNCVsWHfv3q0MMnHMnj1bunfvXuSmBOOtW7eufrFFJCVTateundx00017XOCvv/4S3GToQB555BEpU6aMMoZp06bJa6+9Jmeffbb6OQzjoosuEqwzceJEtc7999+vOp7EkWhKKDqMCeucddZZahp2FUOHDpUePXrItm3blClt2LBBKleurH6PTgc7EpB51apVigCNGzeWWbNmydSpUxWZMAet5t133y2PP/64VK1aVQ4//HDZvn27+t0XX3wh2P2sX79eLrvsMvnkk09UrCAQSNivXz9lbs2aNZPRo0fvYcwfffRR9nUmT54sP/30k4oFndgJJ5wgjz76qMIA8Ue7FFyza9euag7MFib88ccfq6LiGugQE00Jn73iiivk1FNPVd2TTlwpsWMvJ6cq0nt5mdh8LNV80SnxXnLzXoJePPTQQ7Jy5cocXdH8+fOVyaBTQQcFjYEJnXTSSXLLLbfIGWecof6dzJSgl+gyypUrp7on8AMD60J3oDVNmzZVugedgvHcc889SkOwGe/Zs6fg1CrRlD799FOlkeAnNLUgU0oWN3QFMUBnH374YTnooINUY4CNfTINjTqlyJSSaRM8AroIfcRjE2hlSqYEQW7dunUOMQBQJUuWVDsGHJtlZGTIhAkT5I033lBdFYqAFhFODVHFGijUiBEjlPji6A/n24lnqommBCDQ/m3cuFEJNgwOBhg9VwIRMAeiXbZsWTUPiZ1zzjmKPCAC5teuXVtuvvlmqVatWvbxXbR7QNH+/vtvVdC2bdsqU2rQoIEcf/zxKl90ae+9955qt3HdQw45RK6//nplsPgddj5vvvlmDlwSjxwGDRqkdlC4DjC69tpr1Z/jjjtOkS/q6EB4HFHiT82aNdXvb7vtNlmwYIE88MADsmLFCmVSiPOdd95RhohO9dlnn1XmphNXUSh5qiJdFDGZvEaq+cKUeC+5eS9dcskl6vQFYppsQK/OPPNMpX/QGGwkP//8c8HxXTJTgibefvvtMm/ePHXKA6E+7LDDFE9gWNhUQwsirYPGQc+eeOIJtflG5wajxM9hWLg21sScgQMHqjguvfRSZWqJA80CYsLGOFncixcvlvPOO09pIzbK0Hg824fmJdPQRFPKTzPRMNxxxx1Ky2DeaDxSMiUckVWpUiVHUjNmzJDq1asrU4IQwwxmzpypdvAQa3RNEPaTTz5ZunTpokB+9913lctmZWUp8UWBYRzRSDQlmAPOYHEddDpwf4w+ffqoFhVnligUzOqAAw6Q33//XXDsh4K88MILgo4FayN2XCvRLBAjuivsAjCi3cmDDz6ozAOt+v777686EJACpvTKK6+o+T/88IMUK1ZM7WDQyaCzgSlEI7cpvf7669nGBXKtWbNG7TqA20svvSTNmzdXeaATxU4I/47ww5owHxAOOynsiGrUqKGMCOaPm2TMmDFacZkU52jtVEW6KGIyeY1U84Up8V5y816CZhx99NFqk5hsQKhbtGih9AGdDgwDpzsffvhhUlPCRvTcc89VnQfucWyyYQK4v6FL2GxjY4sTG5gb9BQnTDAsDHRZ0CxoCTbq77//vsBAoWUYkSlBVxIH1rrqqquUKSWLG3NgSjjpwgsd0MAOHToofUqmoYmmlJ9m4uQKMUI/YXQYKZlSsiOHHTt2KHGNhP/pp59WborjKAwkAMHt1q2bMiWIffQcCsVDa4vOAR0XOiZ0TmhJYS5wbzh/9HYLjtOmTJmi3B8Fh9HkPr7D+vgZRBzXiXYniCXRLCD02Cmg48GAyaEDARkg8uhKMHB9xAVTQts6bty4Pfj42WefybHHHpvUlGBi0e4K58ggDToydH94wAkzQjeH3IEfChXhh0UhZIgTeAAzDLTRwBx5oHPTicukONOUMgRdcUEjv+M73ksicb6XcP9DI3K/aAQjgIGgk8BJETYqeKSA50/oYAoyJWymoaEYOH2CQd14443qiA4GCENAQ4DHDDAJ3PMQ9IsvvjgH3XCKAn3BuOCCC+S5557LNqWCju+SxY3rJb4chvxx6oWmIpmGJppSfpoZHXs+9thj2Xmk1ZQAPrqmgkwJrSmO0ZAUjtxwBIadAYwGz29wTIXnSN9++63qLtBZ5H5bDubWt29fVcDcpoTs8NwGJoouKZkpQRxQVBQfA0WDoWGHgfYXbXHx4sWVi6OVhikBPByngYAYeJ0TrTk6M3RV0cjdKeHMFGaKkWhK2EV07txZ5YIjQhgVcsYuKLp+hBPm4pkXOk7cFLgmYoWZAjuduAoSzHT8PtXOIR3XtLlGqvnqmBLvpXjeSzjdwEkFNscHH3xwNu2wucT9379/f7VRxjNjbMahYTjtKciUfvzxx+xTKKyLt+Vw/0PDcNrTsGFDtcnG82+YBHQNz80j7YJuHHnkkTJnzhx1eoRHAXhzGaYEcyroRQc0BcnixvWQH2LESDSlZBqaaEr5aSYe48DQ99qUoiO4RAGAU2LHDpfXvZHwMBCtKIBCawtRx3EcuhoAD4NCpwXBR1FhOuhc8DAPD8MgvugWcNaJIzP8Hq+r4/MQbRACro9OB89rkpkSroMjQRBg586d6ggQOwCYJEwRsUD0ES8eKMKU0PHg/HPJkiXZz8awE4Dp4A+e72C3BGOJdhfYPSczJeSIuLETAqFAtOhnKBi6S7T2iAPHmvh79Eo4dhl4XgeDwk2SLK6i/t5VqiJt01DSce1U88WNzHvJzXsJOoHjehgNnodD+6BjOAKD3uBUBUf9uN9xX+MEA0YGHcLvkz1TgplBE2E6V155pTIxaBi6IdzfuPdx9Abjw+OPSLueeeYZtTZOaaCVmB+9fYfTFzQIeMQAc8qvU+rYsWPSuGFCyUwpmYYmmlJ+mokNeqFMKa/vKUFE8bynIFMCaAAbHQ5eIMCbHnjehIdcKEjUWaDlxcAZJ4wKA0Cj6NFAGwvhh1kk+54SHprhvBMuDwOL3s9P7GDQAaFNBigYIAyO0mAOIBregsEzLOx4ADI6ODzLQVcTvTEHUuJhIwwNJon18KwH58f5mRJ+j+tgREdvia+ww+iwIwNGMCxgAPxyvxKOThFHPsgzWVzpEN5U1khVpFNZO45zU8032feUeC+5cS+hc8G9DROIBowHGoVTDXQmL774ovoVXhOH0UAXsKmOtCj395TwYkR0+oJjeHQu69atU4828DwJAz/DiwrYLGMzCpOKdBQdE7ojbFjxXAoba3RaOO6DOeE5WH7fU8Jz8mRxw5CSmVIyDYV+Jn5PKZk2RTjgPYRoaB/fpUMM1q5dq0wJoo2OBi8Z4DlSNAAmCg3Tyf0NaQgvOjGINIBO18Cu4vvvv1fHc1gbA8XEK+goPL6IhqNDtMboYKKuA0TBz9HypuNLb3nlA5yAGc6lc3/fKln+RRFXQdinKtIFrRf339vIl/dSaqxI970E80E3hI4Gjyxyn0bgqKtChQpqs46vzOAPXmDIb+AzeFMtUftwHegTHnfgGtBNdEuRboIH2BgnPjpIDZmcs/cm7rw0NK8YdLXJiikBWBz7xXUAZBwJ4ogFx3l4GQKvZ6Nb4SgYARsiXXBU5mbYyDcyJd5L5urKle0gUKSmhGMonJPiWC5dzm4KttWrV8vzzz+vjuwaNWqkXsAo6mczpnIzva4NkTadU37r28iX95LNivPaJhEoUlMymQjXjg8CNkTaZvah5WsTa17bfwRoSv7XuMgzDE2kQ8u3yAnFCwaFAE0pqHIXTbKhiXRo+RYNi3iVUBGgKYVaeYN5hybSoeVrkDpcmgjo/2+GiBUR0EUgNJEOLV9dHnAeEdgbBNgp7Q1q/Ey+CIQm0qHlS/oTAZMI0JRMohvo2qGJdGj5Bkprpl1ECNCUigjokC4TmkiHlm9IXGauRY8ATanoMff+iqGJdGj5ek9gJmgVAZqSVfj9vHhoIh1avn6yllnFBQGaUlwq4VEcoYl0aPl6RFWmEkMEaEoxLIrrIYUm0qHl6zo/GX+8EaApxbs+TkYXmkiHlq+TpGTQziBAU3KmVO4EGppIh5avO0xkpC4iQFNysWoxjzk0kQ4t35jTj+E5jgBNyfECxjH80EQ6tHzjyDnG5A8CNCV/ahmbTEIT6dDyjQ3RGIiXCNCUvCyr3aRCE+nQ8rXLLl7ddwRoSr5X2EJ+oYl0aPlaoBQvGRACNKWAil1UqYYm0qHlW1Q84nXCRICmFGbd05b19OnTpVixYtK5c+fsNZOJNOZidOnSJW3Xj8NCNKU4VIEx+IIATcmXSlrKY9u2bVKtWjUpX768ZGRkKHPKLdIwI/xs69atsnr1ailXrpylaM1clqZkBleuGiYCNKUw657WrGFGEGYMGFTDhg1l3rx50qZNG8nMzFRGhDFo0CBlXL4NmpJvFWU+NhGgKdlE35NrR93S9u3bk2ZUtmxZL7skJExT8oTITCMWCNCUYlEG94NI7JbyysbXLomm5D53mUG8EKApxasezkaTX7fkc5dEU3KWsgw8pgjQlGJaGBfDStYt+dwl0ZRcZCpjjjMCNKU4V8ex2PLqlnzvkmhKjpGU4cYeAZpS7EvkVoC5uyXfuySaklv8ZLTxR4CmFP8aORVhYrcUQpdEU3KKngzWAQRoSg4UybUQo24phC6JpuQaOxlv3BGgKcW9Qg7Gh24JX6DFF2d9+7835FUOfk/JQZIy5NgiQFOKbWnSExj+v3QcRAAIZGVlEQgiEHsEaEqxL1HhAoQpUYwKh6EPnyYPfKhiGDnQlDyvM8XI8wJrpkceaALFadYRoClZL4HZAChGZvF1ZXXywJVKMU6akuccoBh5XmDN9MgDTaA4zToCNCXrJTAbAMXILL6urE4euFIpxklT8pwDFCPPC6yZHnmgCRSnWUeApmS9BGYDoBiZxdeV1ckDVyrFOGlKnnOAYuR5gTXTIw80geI06wjQlKyXwGwAFCOz+LqyOnngSqUYJ03Jcw5QjDwvsGZ65IEmUJxmHQGakvUSmA2AYmQWX1dWJw9cqRTjpCl5zgGKkecF1kyPPNAEitOsI0BTsl4CswFQjMzi68rq5IErlWKcNCXPOUAx8rzAmumRB5pAcZp1BGhK1ktgNgCKkVl8XVmdPHClUoyTpuQ5ByhGnhdYMz3yQBMoTrOOAE3JegnMBkAxMouvK6uTB65UinHSlDznAMXI8wJrpkceaALFadYRoClZL4HZAChGZvF1ZXXywJVKMU6akuccoBh5XmDN9MgDTaA4zToCNCXrJTAbAMXILL6urE4euFIpxklT8pwDFCPPC6yZHnmgCRSnWUeApmS9BGYDoBiZxdeV1ckDVyrFOGlKnnOAYuR5gTXTIw80geI06wjQlKyXwGwAFCOz+LqyOnngSqUYJ03Jcw74IEbff/+91KxZUzp37izTp0/PrtiUKVPkoYcekg8++CDfKj777LNSv359qVGjhmRkZMjq1atzrOM5BVR6PvAghDoxRxGakucs8EGMIlNCqZYsWSJNmjRRVXv44YfVn4JMqUGDBnLHHXfIxRdfLKtWrZKdO3dK3bp1Pa98zvR84EFQBQs4WZqS58X3QYwiU+rWrZssXbpUPvvsM9l///33MKX77rtPZs2aJbt375aWLVvKiBEjVGd0zz33SJUqVWTatGmyZs0aWb9+vfzzzz+ybds2GTVqlGLAF198IV27dpWFCxfKX3/9JTfeeKO88cYbAkMbNmyYNGrUyGmm+MADpwvA4LURoClpQ+XmRB/EKDKllStXqi4JhtGvX78cpgSjOvfcc9VxXvny5VVXNGnSJDnmmGOkRYsW6uivV69eMnbsWNUttW3bVtq1ayd//PGHlCpVSu6++25ZtGiR6sQaN24s5cqVk/79+8vixYtl6NChsnXrVvUzV4cPPHAVe8adGgI0pdTwcm62D2IUmdKGDRvknXfekTZt2qiOZ8GCBdnHd1999ZUyDhjK2rVrlSmhWxo0aJDqdqLjO/wbpgTDKl26tLz00kvSvHlzqVevntx0003SsGFDOfHEE9WcatWqSVZWlhxyyCEyYcIEad++vXP1jwL2gQfOgs/AU0KAppQSXO5N9kGMEk2pcuXK0qpVKylRooQ0a9Ys25R+/PFHuf3222XmzJlSpkwZVai+ffsmNaUZM2ao4zqsAzOqXbu2bN68WXVGHTp02KPQEydOlGuuucY9AvwvYh944Cz4DDwlBGhKKcHl3mQfxCi3Ka1YsUJq1aqlTGnLli3qRYc+ffrIe++9J7Nnz5aqVasqY0H3k6xTgim98sor6lgP5oXPzp07Vz1Twrp47hSZ25dffqnWhCG6OnzggavYM+7UEKAppYaXc7N9EKPcpoQiDB48WBnOSSedpEwJ3VP16tXVM6Nly5bJmWeeKb1791bzTjjhBOnevbv06NFDfQZHczClXbt2ScWKFeW3336TOXPmqOO5TZs2KfPBSxI33HCDes6EtT///HNlcq4OH3jgKvaMOzUEaEqp4eXcbB/EKC9T2rFjh9SpU0cOPfRQZUrocC666CJVH5gKXm4YN26cZGZmypNPPil4M++pp55S5oLnUdH3na6//no1L3rhAZ/H/I4dO2bXesiQITJgwADnap8YsA88cLoADF4bAZqSNlRuTgxJjPD9o3Xr1qkXFJD3xo0bpUKFClK8eHF1zFe2bFn1d50Bk0JHdfjhh6u3+VwfIfHA9VqFHj9NyXMGUIw8L7BmeuSBJlCcZh0BmpL1EpgNgGJkFl9XVicPXKkU46Qpec4BipHnBdZMjzzQBIrTrCNAU7JeArMBUIzM4uvK6uSBK5VinDQlzzlAMfK8wJrpkQeaQHGadQRoStZLYDYAipFZfF1ZnTxwpVKMk6bkOQcoRp4XWDM98kATKE6zjgBNyXoJzAZAMTKLryurkweuVIpx0pQ85wDFyPMCa6ZHHmgCxWnWEaApWS+B2QAoRmbxdWV18sCVSjFOmpLnHKAYeV5gzfTIA02gOM06AjQl6yUwGwDFyCy+rqxOHrhSKcZJU/KcAxQjzwusmR55oAkUp1lHgKZkvQRmA6AYmf8BiM0AAADlSURBVMXXldXJA1cqxThpSp5zgGLkeYE10yMPNIHiNOsI0JSsl8BsABQjs/i6sjp54EqlGCdNyXMOUIw8L7BmeuSBJlCcZh0BmpL1EpgNgGJkFl9XVicPXKkU46Qpec4BipHnBdZMjzzQBIrTrCNAU7JeArMBUIzM4uvK6uSBK5VinDQlzzlAMfK8wJrpkQeaQHGadQRoStZLYDYAipFZfF1ZnTxwpVKMk6bkOQcoRp4XWDM98kATKE6zjgBNyXoJzAZAMTKLryurkweuVIpx0pQ85wDEiIMIAIGsrCwCQQRij8D/ATHn9x0o4OVjAAAAAElFTkSuQmCC" alt="Image text"></p> <p>JS 层监听 Native 层的消息：EmpJSBridge.on 方法主要用于监听来自 Native 层主动发送的消息，例如 onPullDownRefresh、onShareAppMessage 等。</p> <p><img src="data:image/png;base64,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" alt="Image text"></p> <p>JS 层逻辑层与视图层的消息通信：Service 层或 View 层的 JSBridge 调用 EmpJSBridge.publish 发布消息，publish 发布的消息首先会发给 Native 层，Native 层收到消息后经过处理会调用 JS 层的 EmpJSBridge.subscribeHandler 方法，通过 EmpJSBridge.subscribe 实现消息订阅。</p> <p><img src="/assets/img/jsbridge-publish-subscribe.3b25b0bc.png" alt="Image text"></p> <h4 id="android-层设计"><a href="#android-层设计" class="header-anchor">#</a> Android 层设计</h4> <p>JSBridge 中的 invoke 方法和 publish 方法在不同平台调用不同的方法：Android 平台调用 EmpJSCore.invokeHandler / EmpJSCore.publishHandler 方法，iOS 平台调用 webkit.messageHandlers.invokeHandler.postMessage。这里的 JSCore 对象通过 WebView addJavascriptInterface 方法对外暴露接口。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token function">addJavascriptInterface</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JSInterface</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;EmpJSCore&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>以 <code>mpJSCore.invokeHandler</code> 为例说明，JSInterface 接口实现如下，EmpJSCore.invokeHandler 将 JS 层传递过来的 eventName、paramsString、callbackId 三个参数传入到 mBridgeHandler.invoke 方法中。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JSInterface</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">TAG</span> <span class="token operator">=</span> <span class="token string">&quot;JSInterface&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">IBridge</span> mBridgeHandler<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Handler</span> mHandler <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Handler</span><span class="token punctuation">(</span><span class="token class-name">Looper</span><span class="token punctuation">.</span><span class="token function">getMainLooper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">JSInterface</span><span class="token punctuation">(</span><span class="token class-name">IBridge</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mBridgeHandler <span class="token operator">=</span> handler<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@JavascriptInterface</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">publishHandler</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> event<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> params<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> viewIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">EmpTrace</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;publishHandler is called! event=%s, params=%s, viewIds=%s&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">,</span> params<span class="token punctuation">,</span> viewIds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mBridgeHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mBridgeHandler<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> params<span class="token punctuation">,</span> viewIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@JavascriptInterface</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">invokeHandler</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> event<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> params<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> callbackId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">EmpTrace</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;invokeHandler is called! event=%s, params=%s, callbackId=%s&quot;</span><span class="token punctuation">,</span>
                event<span class="token punctuation">,</span> params<span class="token punctuation">,</span> callbackId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        mHandler<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>mBridgeHandler <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    mBridgeHandler<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> params<span class="token punctuation">,</span> callbackId<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br></div></div><p>这里的 mBridgeHandler 是一个 IBridge 接口实现类实例，具体实现在 AppService 和 Page 中，mBridgeHandler.invoke 方法具体实现为：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">invoke</span><span class="token punctuation">(</span><span class="token class-name">String</span> event<span class="token punctuation">,</span> <span class="token class-name">String</span> params<span class="token punctuation">,</span> <span class="token class-name">String</span> callbackId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token class-name">EmpTrace</span><span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token constant">TAG</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;api invoke, event=%s, params=%s, callbackId=%s&quot;</span><span class="token punctuation">,</span>
                                event<span class="token punctuation">,</span> params<span class="token punctuation">,</span> callbackId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">Event</span> e <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> params<span class="token punctuation">,</span> callbackId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  mApisManager<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Native 层调用 API Manager 的invoke 方法实现功能调用，处理完成后 Native 层调用 AppService 层的 callback 方法实现消息回调：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">callback</span><span class="token punctuation">(</span><span class="token class-name">String</span> callbackId<span class="token punctuation">,</span> <span class="token class-name">String</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  mServiceWebView<span class="token punctuation">.</span><span class="token function">loadUrl</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;javascript:EmpJSBridge.invokeCallbackHandler(%s,%s)&quot;</span><span class="token punctuation">,</span> callbackId<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="视图层与逻辑层通信"><a href="#视图层与逻辑层通信" class="header-anchor">#</a> 视图层与逻辑层通信</h4> <p>视图层 DOM Ready、点击等操作事件通过 bridge.publish 发布事件消息：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 发布页面事件
 * @param {string} eventName 事件名称
 * @param {any} data 事件数据
 */</span>
<span class="token keyword">function</span> <span class="token function">publishPageEvent</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">eventName</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">data</span><span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  bridge<span class="token punctuation">.</span><span class="token function">publish</span><span class="token punctuation">(</span>EventType<span class="token punctuation">.</span><span class="token constant">PAGE_EVENT</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    eventName<span class="token punctuation">,</span>
    data
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>逻辑层监听事件：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">/**
 * 订阅页面事件
 * @param {*} fn
 */</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">onWebviewEvent</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">callback</span><span class="token operator">:</span> Function</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  bridge<span class="token punctuation">.</span><span class="token function">subscribe</span><span class="token punctuation">(</span>EventType<span class="token punctuation">.</span><span class="token constant">PAGE_EVENT</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token constant">EMP</span><span class="token punctuation">.</span>PageEventData<span class="token punctuation">,</span> <span class="token literal-property property">webviewId</span><span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> event <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token punctuation">{</span> webviewId <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token function">callback</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    global<span class="token punctuation">.</span><span class="token function">__empconsole__</span><span class="token punctuation">(</span>
      <span class="token string">'AppService'</span><span class="token punctuation">,</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Subscribe PageEvent: data: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, webviewId: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>webviewId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <ul><li><p><a href="/word/applet.html">小程序学习资源</a></p></li> <li><p><a href="https://zhuanlan.zhihu.com/p/81775922" target="_blank" rel="noopener noreferrer">小程序底层实现原理及一些思考<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p><a href="https://mp.weixin.qq.com/s/Q3Dfrcf5FTmWUrsIkPWncA" target="_blank" rel="noopener noreferrer">小程序技术演进史<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ul></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">11/24/2021, 4:38:46 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev"><a href="/word/applet-principle.html" class="prev">
          第十一章、微信小程序技术原理分析
        </a></span> <span class="next"><a href="/word/applet.html">
          第九章、小程序
        </a></span></p></div> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-ff035a48 data-v-2a0acbb5><li class="level-2" data-v-ff035a48><a href="/word/applet-engine.html#背景" class="sidebar-link reco-side-背景" data-v-ff035a48>背景</a></li><li class="level-2" data-v-ff035a48><a href="/word/applet-engine.html#小程序-native-web" class="sidebar-link reco-side-小程序-native-web" data-v-ff035a48>小程序 &amp; Native &amp; Web</a></li><li class="level-2" data-v-ff035a48><a href="/word/applet-engine.html#重新认识浏览器内核" class="sidebar-link reco-side-重新认识浏览器内核" data-v-ff035a48>重新认识浏览器内核</a></li><li class="level-3" data-v-ff035a48><a href="/word/applet-engine.html#browser-engine" class="sidebar-link reco-side-browser-engine" data-v-ff035a48>Browser engine</a></li><li class="level-3" data-v-ff035a48><a href="/word/applet-engine.html#javascript-engine" class="sidebar-link reco-side-javascript-engine" data-v-ff035a48>JavaScript Engine</a></li><li class="level-3" data-v-ff035a48><a href="/word/applet-engine.html#how-webkit-works" class="sidebar-link reco-side-how-webkit-works" data-v-ff035a48>How WebKit works</a></li><li class="level-3" data-v-ff035a48><a href="/word/applet-engine.html#how-blink-works" class="sidebar-link reco-side-how-blink-works" data-v-ff035a48>How Blink works</a></li><li class="level-2" data-v-ff035a48><a href="/word/applet-engine.html#主流小程序引擎架构" class="sidebar-link reco-side-主流小程序引擎架构" data-v-ff035a48>主流小程序引擎架构</a></li><li class="level-3" data-v-ff035a48><a href="/word/applet-engine.html#微信小程序架构" class="sidebar-link reco-side-微信小程序架构" data-v-ff035a48>微信小程序架构</a></li><li class="level-3" data-v-ff035a48><a href="/word/applet-engine.html#百度小程序架构" class="sidebar-link reco-side-百度小程序架构" data-v-ff035a48>百度小程序架构</a></li><li class="level-3" data-v-ff035a48><a href="/word/applet-engine.html#支付宝小程序架构" class="sidebar-link reco-side-支付宝小程序架构" data-v-ff035a48>支付宝小程序架构</a></li><li class="level-3" data-v-ff035a48><a href="/word/applet-engine.html#快应用架构" class="sidebar-link reco-side-快应用架构" data-v-ff035a48>快应用架构</a></li><li class="level-2" data-v-ff035a48><a href="/word/applet-engine.html#emp-小程序引擎设计" class="sidebar-link reco-side-emp-小程序引擎设计" data-v-ff035a48>EMP 小程序引擎设计</a></li><li class="level-3" data-v-ff035a48><a href="/word/applet-engine.html#整体架构" class="sidebar-link reco-side-整体架构" data-v-ff035a48>整体架构</a></li><li class="level-3" data-v-ff035a48><a href="/word/applet-engine.html#包结构" class="sidebar-link reco-side-包结构" data-v-ff035a48>包结构</a></li><li class="level-3" data-v-ff035a48><a href="/word/applet-engine.html#启动流程" class="sidebar-link reco-side-启动流程" data-v-ff035a48>启动流程</a></li><li class="level-3" data-v-ff035a48><a href="/word/applet-engine.html#编译器" class="sidebar-link reco-side-编译器" data-v-ff035a48>编译器</a></li><li class="level-3" data-v-ff035a48><a href="/word/applet-engine.html#通信机制" class="sidebar-link reco-side-通信机制" data-v-ff035a48>通信机制</a></li><li class="level-2" data-v-ff035a48><a href="/word/applet-engine.html#参考" class="sidebar-link reco-side-参考" data-v-ff035a48>参考</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.1209b5ce.js" defer></script><script src="/assets/js/4.de537007.js" defer></script><script src="/assets/js/1.f2ff10e3.js" defer></script><script src="/assets/js/5.157bb445.js" defer></script>
  </body>
</html>
